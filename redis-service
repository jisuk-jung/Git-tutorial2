using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using StackExchange.Redis;

public class RedisSubscriberService : BackgroundService
{
    private readonly IConnectionMultiplexer _redis;
    private readonly ILogger<RedisSubscriberService> _logger;

    public RedisSubscriberService(
        IConnectionMultiplexer redis,
        ILogger<RedisSubscriberService> logger)
    {
        _redis = redis;
        _logger = logger;
    }

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _logger.LogInformation("Redis Subscriber Background Service starting...");

        var subscriber = _redis.GetSubscriber();

        // Redis ì±„ë„ êµ¬ë…
        await subscriber.SubscribeAsync("config_changed", async (channel, message) =>
        {
            _logger.LogInformation($"[Redis] Received: {message}");

            // ğŸ‘‰ ì—¬ê¸°ì„œ DB ì¬ì¡°íšŒ, ìºì‹œ ì—…ë°ì´íŠ¸ ë“± ì‹¤í–‰
            await ReloadCacheAsync();
        });

        // BackgroundServiceëŠ” ì¢…ë£Œ ì‹ í˜¸ê°€ ì˜¤ê¸° ì „ê¹Œì§€ ê³„ì† ëŒ€ê¸°
        while (!stoppingToken.IsCancellationRequested)
        {
            await Task.Delay(1000, stoppingToken);
        }

        _logger.LogInformation("Redis Subscriber Background Service stopping...");
    }

    private async Task ReloadCacheAsync()
    {
        _logger.LogInformation("Reloading cache from DB...");

        // Fake DB call
        await Task.Delay(300);

        // ì—¬ê¸°ì„œ ì‹¤ì œ DBì—ì„œ ê°’ì„ ì½ì–´ ë©”ëª¨ë¦¬ì— ì €ì¥
        InMemoryCache.Config = $"NEW-VALUE: {Guid.NewGuid()}";

        _logger.LogInformation("Cache update completed.");
    }
}
